<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Battleboard 3.0 ğŸ®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#fae8ff">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui;
      line-height: 1.5;
      color: #1f2937;
      background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 30%, #e0f2fe 70%, #ecfeff 100%);
      min-height: 100vh;
    }
    body {
      margin: 0;
      padding: 14px;
      max-width: 780px;
      margin-inline: auto;
      box-sizing: border-box;
    }
    h1 {
      font-size: 22px;
      margin: 0 0 4px 0;
    }
    h2 {
      font-size: 17px;
      margin: 10px 0 6px;
    }
    h3 {
      font-size: 14px;
      margin: 8px 0 4px;
    }
    .top-card {
      background: linear-gradient(135deg, #0ea5e9 0%, #4f46e5 40%, #a855f7 100%);
      border-radius: 16px;
      padding: 12px 14px;
      margin-bottom: 12px;
      color: #f9fafb;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.5);
    }
    .flex-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .date {
      font-size: 13px;
      opacity: 0.9;
    }
    .stat {
      font-size: 13px;
      margin-top: 4px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.32);
      border: 1px solid rgba(15, 23, 42, 0.5);
      margin-left: 4px;
    }
    .card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      border-radius: 14px;
      padding: 10px 12px;
      margin-bottom: 10px;
      border: 1px solid rgba(147, 51, 234, 0.2);
      box-shadow: 0 4px 15px rgba(147, 51, 234, 0.1);
    }
    .tag {
      display: inline-block;
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      margin-right: 4px;
      margin-bottom: 4px;
      background: linear-gradient(135deg, #a855f7, #6366f1);
      color: #fff;
    }
    label {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 13px;
      margin: 4px 0;
    }
    input[type="checkbox"] {
      margin-top: 3px;
      min-width: 18px;
      min-height: 18px;
      accent-color: #4f46e5;
    }
    textarea {
      width: 100%;
      min-height: 60px;
      border-radius: 10px;
      border: 1px solid #e9d5ff;
      padding: 6px 8px;
      font-size: 13px;
      resize: vertical;
      box-sizing: border-box;
      background: rgba(255, 255, 255, 0.9);
      color: #1f2937;
    }
    textarea:focus,
    input:focus {
      outline: none;
      border-color: #a855f7;
      box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.2);
    }
    .small {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 13px;
      cursor: pointer;
      background: #22c55e;
      color: #022c22;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 8px 16px rgba(22, 163, 74, 0.5);
    }
    button.secondary {
      background: #fff;
      color: #6b7280;
      box-shadow: none;
      border: 1px solid #e5e7eb;
    }
    button.ghost {
      background: transparent;
      color: #7c3aed;
      border: 1px dashed #c4b5fd;
      box-shadow: none;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }
    .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }
    .xp-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.5);
      overflow: hidden;
      margin-top: 6px;
    }
    .xp-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #eab308, #fb923c);
      transition: width 0.25s ease-out;
    }
    .pill {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(147, 51, 234, 0.1);
      color: #7c3aed;
    }
    .emoji-row {
      min-height: 24px;
      font-size: 20px;
      margin-top: 4px;
      word-wrap: break-word;
    }
    .weekly-grid {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .day-cell {
      width: 38px;
      text-align: center;
      font-size: 10px;
      color: #9ca3af;
    }
    .day-box {
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid #e9d5ff;
      padding: 2px 1px;
      min-height: 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
    }
    .day-box.win {
      border-color: #22c55e;
      background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(16,185,129,0.2));
      box-shadow: 0 0 10px rgba(34,197,94,0.3);
    }
    .day-emoji-line {
      font-size: 14px;
      line-height: 1.1;
    }
    .lottery-box {
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(250,204,21,0.1));
      border: 1px solid rgba(34,197,94,0.3);
      padding: 10px;
    }
    .lottery-result {
      font-size: 14px;
      margin-top: 6px;
      color: #374151;
    }
    .lottery-highlight {
      font-size: 16px;
      margin-top: 4px;
      color: #d97706;
      font-weight: bold;
    }
    /* Treasure chest animation */
    .chest-container {
      text-align: center;
      margin: 16px 0;
    }
    .treasure-chest {
      font-size: 60px;
      display: inline-block;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .treasure-chest:hover {
      transform: scale(1.1);
    }
    .treasure-chest.shaking {
      animation: shake 0.3s ease infinite;
    }
    .treasure-chest.opening {
      animation: openChest 0.5s ease forwards;
    }
    @keyframes shake {
      0%, 100% { transform: rotate(-5deg) scale(1.1); }
      50% { transform: rotate(5deg) scale(1.1); }
    }
    @keyframes openChest {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1) rotate(10deg); }
    }
    .confetti {
      position: fixed;
      font-size: 24px;
      pointer-events: none;
      animation: confettiFall 3s ease-out forwards;
      z-index: 1000;
    }
    @keyframes confettiFall {
      0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    .prize-reveal {
      animation: prizeReveal 0.5s ease;
    }
    @keyframes prizeReveal {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="top-card">
    <div class="flex-row">
      <div>
        <h1>Battleboard 3.0 ğŸ®</h1>
        <div class="date" id="today"></div>
        <div class="stat" id="metaText"></div>
      </div>
      <div>
        <div class="badge" id="streakBadge">è¿èƒœï¼š0 å¤© ğŸ”¥</div>
        <div class="badge" id="levelBadge">Lv.1 Â· 0 XP</div>
      </div>
    </div>
    <div class="xp-bar">
      <div class="xp-fill" id="xpFill" style="width: 0%"></div>
    </div>
    <div class="small">
      è§„åˆ™ï¼š<br />
      - ä»Šå¤©åªè¦æœ‰ â‰¥1 ä¸ª emojiï¼Œè¿èƒœå°±ç»§ç»­ã€‚ï¼ˆä½ åœ¨è®¤å¯è‡ªå·±ï¼Œè€Œä¸æ˜¯å®¡åˆ¤è‡ªå·±ï¼‰<br />
      - ä¸»çº¿é€šå…³æ‰åŠ  XPï¼Œæ˜¯æˆé•¿çš„ã€Œç¨€æœ‰æ‰è½ã€ã€‚
    </div>
  </div>

  <div class="card">
    <div class="btn-row">
      <span class="tag">ä»Šæ—¥æ§åˆ¶å°</span>
      <div style="display:flex; gap:6px; flex-wrap:wrap;">
        <button id="addEmojiBtn" class="ghost">+ ä»Šæ—¥ emoji</button>
        <button id="mainQuestBtn">ğŸ”¥ ä¸»çº¿é€šå…³</button>
        <button id="resetToday" class="secondary">é‡ç½®ä»Šå¤©</button>
      </div>
    </div>
    <div class="small">
      å»ºè®®ï¼šä»»ä½•ä½ æ„¿æ„è®¤å¯çš„åŠªåŠ›ï¼ˆè·‘å®éªŒ / è¿åŠ¨ / å¥åº·é¥®é£Ÿ / æƒ…ç»ªç®¡ç† / æ”¶æ‹¾å®¶ / æƒ³æ³•ç­‰ï¼‰ï¼Œéƒ½å¯ä»¥åŠ ä¸€ä¸ª emojiã€‚<br />
      æ¯å¤©è‡³å°‘åŠ ä¸€ä¸ª emojiï¼Œå°±è¶³å¤Ÿç»´æŒ streakã€‚
    </div>
    <h3>ä»Šå¤©çš„ emoji</h3>
    <div id="todayEmojis" class="emoji-row"></div>
  </div>

  <div class="card">
    <h2>1. ç§‘ç ”ï¼ˆS çº§ä¸»çº¿ï¼‰</h2>
    <span class="tag">ä¸»çº¿ä»»åŠ¡</span>
    <label>
      <input type="checkbox" data-key="research_block1" />
      <span>â‰¥ 1 ä¸ªæ·±åº¦å·¥ä½œå—ï¼ˆ60â€“90minï¼‰ï¼šæ¨å¯¼ / ä»£ç  / æ•°æ®åˆ†æï¼ˆå…¨ç¨‹è¿œç¦»æ‰‹æœºï¼‰ã€‚</span>
    </label>
    <label>
      <input type="checkbox" data-key="research_block2" />
      <span>ç¬¬ 2 ä¸ªæ·±åº¦å·¥ä½œå—ï¼ˆ60â€“90minï¼‰ã€‚å®éªŒæ’æ»¡å¯ç”¨ã€Œå®éªŒ+åˆ†æã€æ›¿ä»£ã€‚</span>
    </label>
    <label>
      <input type="checkbox" data-key="research_summary" />
      <span>å†™ä¸€å¥è¯ï¼š<em>ã€Œä»Šå¤©ç§‘ç ”ä¸Šï¼Œæˆ‘çœŸæ­£æ¨è¿›çš„ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿã€</em></span>
    </label>
    <h3>ä»Šå¤©ç§‘ç ” 1â€“3 ä¸ªå…³é”®ä»»åŠ¡</h3>
    <textarea id="research_plan" placeholder="ä¾‹å¦‚ï¼š1ï¼‰æ•´ç†ä¸Šæ¬¡å®éªŒæ•°æ®ï¼›2ï¼‰æ¨å®ŒæŸä¸ªå…¬å¼ï¼›3ï¼‰å†™ä¸€é¡µ noteâ€¦â€¦"></textarea>
    <p class="small">ç§‘ç ”æ˜¯ä½ æ‰€æœ‰æœªæ¥èº«ä»½çš„åº•å±‚ç®—åŠ›è®­ç»ƒåœºï¼Œä¸æ˜¯ä¸ºäº†å¯¼å¸ˆï¼Œæ˜¯ä¸ºäº†æœªæ¥çš„ä½ ã€‚</p>
  </div>

  <div class="card">
    <h2>2. é‡åŒ– / è‚¡ç¥¨ï¼ˆA çº§æ”¯çº¿ï¼‰</h2>
    <span class="tag">æ”¯çº¿ä»»åŠ¡</span>
    <p class="small">
      ä¸è®¡å…¥ä¸»çº¿é€šå…³ç¡¬æ€§è¦æ±‚ï¼Œä½†é•¿æœŸå¤åˆ©ã€‚<br />
      éšæ‰‹è®°å½•æƒ³æ³•ã€é—®é¢˜ã€å¸‚åœºè§‚å¯Ÿå³å¯ã€‚
    </p>
    <label>
      <input type="checkbox" data-key="quant_prepare" />
      <span>è®°ä¸‹æƒ³ææ‡‚çš„ 1â€“3 ä¸ªé—®é¢˜ / æƒ³ç ”ç©¶çš„ç‚¹ã€‚</span>
    </label>
    <label>
      <input type="checkbox" data-key="quant_note" />
      <span>éšæ‰‹å†™ä¸€å¥å¯¹æœ€è¿‘å¸‚åœº / ç­–ç•¥çš„è§‚å¯Ÿã€‚</span>
    </label>
    <h3>é‡åŒ–ç›¸å…³éšæ‰‹è®°å½•</h3>
    <textarea id="quant_plan" placeholder="ä¾‹å¦‚ï¼šæƒ³é—®çš„é—®é¢˜ã€æ ‡çš„é€‰æ‹©ã€é£é™©åå¥½ã€ç­–ç•¥æ–¹å‘â€¦â€¦"></textarea>
  </div>

  <div class="card">
    <h2>3. è‡ªåª’ä½“ / è¾“å‡ºï¼ˆB çº§æ”¯çº¿ï¼‰</h2>
    <p class="small">
      äººè®¾å»ºè®®ï¼š<br />
      <strong>ã€Œåšé‡å­ + åšé‡åŒ– + è®²å¥³æ€§ç°å®ä¸»ä¹‰çš„ PhD äººç”Ÿå®éªŒæ—¥å¿—ã€‚ã€</strong><br />
      ä»Šå¤©æ²¡æ›´ä¸æ‰£åˆ†ï¼Œä½†ä¸èƒ½ç”¨å®ƒé€ƒé¿ç§‘ç ”ã€‚
    </p>
    <label>
      <input type="checkbox" data-key="media_brainstorm" />
      <span>èŠ± 10â€“15min æƒ³ 1â€“3 ä¸ªé€‰é¢˜ï¼šç§‘ç ”ç¿»è½¦æ•…äº‹ / å¥³æ€§ç”Ÿå­˜ç»†èŠ‚ / é’±ä¸é£é™©çš„ç°å®æ„Ÿæ‚Ÿã€‚</span>
    </label>
    <label>
      <input type="checkbox" data-key="media_create" />
      <span>ç”¨ 30â€“60min è¾“å‡ºä¸€æ¡å†…å®¹ï¼ˆè‰ç¨¿ / å½•åˆ¶ / åˆå‰ªéƒ½ç®—ï¼Œä¸æ±‚å®Œç¾ï¼‰ã€‚</span>
    </label>
    <h3>ä»Šå¤©çš„é€‰é¢˜ / æƒ³è®°å½•çš„ç‚¹</h3>
    <textarea id="media_ideas" placeholder="ä¾‹å¦‚ï¼šä»Šå¤©å®éªŒç¿»è½¦å¿ƒå¾—ã€æŸä¸ªå¥³æ€§ç”Ÿå­˜è¯é¢˜ã€å¯¹é’± / é£é™©çš„ä¸€ä¸ªæ´å¯Ÿâ€¦â€¦"></textarea>
  </div>

  <div class="card">
    <h2>4. æ™šé—´ 3 é—®ï¼ˆç”¨ 3 åˆ†é’Ÿæ”¶å°¾ä»Šå¤©ï¼‰</h2>
    <label>
      <input type="checkbox" data-key="review_q1" />
      <span>ä»Šå¤©ä¸‰æ¡çº¿é‡Œï¼Œå“ªä¸€æ¡æ¨è¿›æœ€å¤§ï¼Ÿå†™ä¸€å¥å…·ä½“è¯æ®ã€‚</span>
    </label>
    <label>
      <input type="checkbox" data-key="review_q2" />
      <span>æˆ‘ä»Šå¤©æœ€æµªè´¹æ—¶é—´çš„ä¸€ä»¶äº‹æ˜¯ä»€ä¹ˆï¼Ÿæ˜å¤©å‡†å¤‡æ€ä¹ˆæŒ¡ä½å®ƒï¼Ÿ</span>
    </label>
    <label>
      <input type="checkbox" data-key="review_q3" />
      <span>å¦‚æœæ˜å¤©åªèƒ½åšå¥½ä¸€ä»¶äº‹ï¼Œæœ€å€¼å¾—çš„æ˜¯å“ªä¸€ä»¶ï¼Ÿ</span>
    </label>
    <textarea id="review_notes" placeholder="éšä¾¿å†™å‡ å¥ï¼Œä¸ç”¨æ–‡è‰ºï¼Œåªè¦è¯šå®ã€‚"></textarea>
    <p class="small">ä½ åœ¨è¯„ä»·çš„æ˜¯ã€Œä»Šå¤©çš„è¡Œä¸ºã€ï¼Œä¸æ˜¯ä½ è¿™ä¸ªäººã€‚å†™ä¸¤ä¸‰å¥ï¼Œå°±å·²ç»åœ¨å‡çº§ã€‚</p>
  </div>

  <div class="card">
    <div class="flex-row">
      <span class="tag">æœ€è¿‘ 7 å¤© emoji æ—¥å†</span>
      <span class="pill" id="weekSummaryText">åŠ è½½ä¸­...</span>
    </div>
    <div class="weekly-grid" id="weeklyGrid"></div>
    <p class="small">
      æ¯å¤©å±•ç¤ºä¼˜å…ˆçº§æœ€é«˜çš„ 2 ä¸ª emojiï¼ˆä¸»çº¿ / æ”¯çº¿ / åŸºç¡€ï¼‰ã€‚<br />
      ç›®æ ‡ä¸æ˜¯å®Œç¾å…¨ç»¿ï¼Œè€Œæ˜¯å°½é‡å‡å°‘ã€Œå®Œå…¨ç©ºç™½çš„ä¸€å¤©ã€ã€‚
    </p>
  </div>

  <div class="card lottery-box">
    <div class="flex-row">
      <span class="tag">å‘¨æŠ½å¥–æ±  ğŸ</span>
      <span class="pill" id="lotteryStatus">è¿ç»­ 7 å¤©æœ‰ emoji å³å¯è§£é”å®ç®±</span>
    </div>
    <div class="small">
      è¿ç»­ 7 å¤©æ¯å¤©è‡³å°‘ 1 ä¸ª emojiï¼ˆstreak â‰¥ 7ï¼‰â†’ è§£é”ä¸€æ¬¡æŠ½å¥–ã€‚<br />
      å¥–åŠ±æ± å¯éšæ—¶ä¿®æ”¹ï¼Œæ˜¯ä½ å¯¹è‡ªå·±çš„ã€Œå°å¤¸å¥–ã€å’Œã€Œèƒ½é‡è¡¥ç»™ã€ã€‚
    </div>
    <div class="chest-container">
      <div class="treasure-chest" id="treasureChest" onclick="runLottery()" style="display:none;">ğŸ</div>
      <div id="lockedChest" style="font-size:40px; opacity:0.4;">ğŸ”’</div>
    </div>
    <div class="lottery-result" id="lotteryResult"></div>
    <div class="lottery-highlight" id="lotteryPrize"></div>
    <h3>å¥–æ± è®¾ç½®ï¼ˆæ¯è¡Œä¸€ä¸ªå¿ƒæ„¿ / å¥–åŠ±ï¼‰</h3>
    <textarea id="prizePoolInput" placeholder="æ¯è¡Œä¸€ä¸ªå¥–åŠ±ï¼Œä¾‹å¦‚ï¼š&#10;ğŸ£ åƒä¸€é¡¿å¤§é¤&#10;ğŸ› ä¹°ä¸€ä¸ªå°ä¸œè¥¿&#10;â˜•ï¸ å» cafÃ© åä¸€ä¸‹åˆ"></textarea>
  </div>

  <div class="card">
    <div class="flex-row">
      <span class="pill" id="progressText"></span>
      <button id="copySummary">å¤åˆ¶ä»Šå¤©æˆ˜æŠ¥</button>
    </div>
    <p class="small">
      å¯æŠŠæˆ˜æŠ¥è´´åˆ°ä½ çš„ã€Šä¸‰çº¿æˆ˜æ–—æ—¥è®°ã€‹æˆ– Notion é‡Œï¼Œå½¢æˆ 90 å¤©ä½œæˆ˜è®°å½•ã€‚
    </p>
  </div>

  <script>
    const todayKey = new Date().toISOString().slice(0, 10);
    const STORAGE_KEY = "three_line_warboard_v3";
    const META_KEY = "three_line_meta_v3";

    const todayEl = document.getElementById("today");
    const metaText = document.getElementById("metaText");
    const streakBadge = document.getElementById("streakBadge");
    const levelBadge = document.getElementById("levelBadge");
    const xpFill = document.getElementById("xpFill");
    const resetBtn = document.getElementById("resetToday");
    const mainQuestBtn = document.getElementById("mainQuestBtn");
    const addEmojiBtn = document.getElementById("addEmojiBtn");
    const copyBtn = document.getElementById("copySummary");
    const progressText = document.getElementById("progressText");
    const todayEmojisEl = document.getElementById("todayEmojis");
    const weeklyGrid = document.getElementById("weeklyGrid");
    const weekSummaryText = document.getElementById("weekSummaryText");
    const lotteryStatus = document.getElementById("lotteryStatus");
    const lotteryResult = document.getElementById("lotteryResult");
    const lotteryPrize = document.getElementById("lotteryPrize");
    const prizePoolInput = document.getElementById("prizePoolInput");

    (function setDate() {
      const d = new Date();
      const week = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"][d.getDay()];
      todayEl.textContent = `ä»Šå¤©ï¼š${todayKey}ï¼ˆå‘¨${week}ï¼‰`;
    })();

    function loadAll() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
      } catch {
        return {};
      }
    }
    function saveAll(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    function loadMeta() {
      try {
        return JSON.parse(
          localStorage.getItem(META_KEY) ||
            '{"xp":0,"streak":0,"lastWinDate":null,"lastEmojiDate":null,"totalDraws":0,"prizePool":[],"lastPrizeResult":null}'
        );
      } catch {
        return {
          xp: 0,
          streak: 0,
          lastWinDate: null,
          lastEmojiDate: null,
          totalDraws: 0,
          prizePool: [],
          lastPrizeResult: null,
        };
      }
    }
    function saveMeta(meta) {
      localStorage.setItem(META_KEY, JSON.stringify(meta));
    }
    function loadToday() {
      const all = loadAll();
      return all[todayKey] || {};
    }
    function saveToday(partial) {
      const all = loadAll();
      all[todayKey] = { ...(all[todayKey] || {}), ...partial };
      saveAll(all);
      updateProgress();
      updateTodayEmojis();
      updateWeeklyView();
    }

    function ensureDefaultPrizePool(meta) {
      if (!meta.prizePool || !Array.isArray(meta.prizePool) || meta.prizePool.length === 0) {
        meta.prizePool = [
          "ğŸ£ åƒä¸€é¡¿å¤§é¤",
          "ğŸ› ä¹°ä¸€ä¸ªå°ä¸œè¥¿",
          "â˜•ï¸ å» cafÃ© åä¸€ä¸‹åˆ",
          "ğŸ§´ ä¹°æŠ¤è‚¤å“",
          "ğŸ› æ³¡æ¾¡",
          "ğŸ’†â€â™€ï¸ å…¨èº«æŠ¤ç†",
          "ğŸ° åƒä¸€ä»½å–œæ¬¢çš„ç”œç‚¹",
          "ğŸ§‹ å¥¶èŒ¶å¥–åŠ±",
          "ğŸ® ç©æ¸¸æˆ 1 å°æ—¶",
          "ğŸ“¦ ä¹°è´­ç‰©è½¦é‡Œçš„ä¸€ä¸ªä¸œè¥¿",
        ];
      }
      return meta;
    }

    function init() {
      const data = loadToday();
      let meta = loadMeta();
      meta = ensureDefaultPrizePool(meta);
      saveMeta(meta);

      document
        .querySelectorAll('input[type="checkbox"][data-key]')
        .forEach((cb) => {
          const key = cb.getAttribute("data-key");
          cb.checked = !!data[key];
          cb.addEventListener("change", () => {
            saveToday({ [key]: cb.checked });
          });
        });

      const map = {
        research_plan: "research_plan",
        quant_plan: "quant_plan",
        media_ideas: "media_ideas",
        review_notes: "review_notes",
      };
      Object.entries(map).forEach(([id, key]) => {
        const el = document.getElementById(id);
        el.value = data[key] || "";
        el.addEventListener("input", () => {
          saveToday({ [key]: el.value });
        });
      });

      updateMetaUI();
      updateProgress();
      updateTodayEmojis();
      initPrizePoolUI();
      updateWeeklyView();
      updateLotteryUI();
    }

    function updateMetaUI() {
      const meta = loadMeta();
      const xp = meta.xp || 0;
      const streak = meta.streak || 0;
      const level = Math.floor(xp / 100) + 1;
      const xpInLevel = xp % 100;
      const xpPercent = Math.min(100, (xpInLevel / 100) * 100);

      streakBadge.textContent = `è¿èƒœï¼š${streak} å¤© ğŸ”¥`;
      levelBadge.textContent = `Lv.${level} Â· ${xp} XP`;
      xpFill.style.width = xpPercent + "%";

      metaText.textContent =
        "ä½ åœ¨ç»ƒçš„æ˜¯ã€Œä»Šå¤©æœ‰æ²¡æœ‰ç»™è‡ªå·±ä¸€ç‚¹è‚¯å®šã€ï¼Œè€Œä¸æ˜¯ã€Œæœ‰æ²¡æœ‰å®Œç¾ã€ã€‚åªè¦è¿˜åœ¨å›æ¥ï¼Œä½ å°±åœ¨èµ¢ã€‚";
    }

    function updateProgress() {
      const checkboxes = Array.from(
        document.querySelectorAll('input[type="checkbox"][data-key]')
      );
      const total = checkboxes.length;
      const done = checkboxes.filter((cb) => cb.checked).length;
      const percent = total ? Math.round((done / total) * 100) : 0;
      progressText.textContent = `ä»Šæ—¥å‹¾é€‰é¡¹ï¼š${done}/${total}ï¼ˆçº¦ ${percent}% ï¼‰`;
    }

    function updateTodayEmojis() {
      const data = loadToday();
      const emojis = data.emojis || [];
      todayEmojisEl.textContent = emojis.join(" ");
    }

    function registerFirstEmojiIfNeeded() {
      const data = loadToday();
      if (data._emojiRegisteredForStreak) return;

      const meta = loadMeta();
      const todayDate = new Date(todayKey);

      if (!meta.lastEmojiDate) {
        meta.streak = 1;
      } else {
        const last = new Date(meta.lastEmojiDate);
        const diffDays = Math.round(
          (todayDate - last) / (1000 * 60 * 60 * 24)
        );
        if (diffDays === 1) {
          meta.streak = (meta.streak || 0) + 1;
        } else {
          meta.streak = 1;
        }
      }
      meta.lastEmojiDate = todayKey;
      saveMeta(meta);

      saveToday({ _emojiRegisteredForStreak: true });
      updateMetaUI();
      updateLotteryUI();
    }

    function addEmoji() {
      const input = prompt("è¾“å…¥ä½ æƒ³è®°å½•çš„ emojiï¼ˆå¯ä»¥æ˜¯ä¸€ä¸ªæˆ–ä¸€ä¸²ï¼Œä¾‹å¦‚ï¼šğŸŒ± æˆ– ğŸŒ±âœ¨ï¼‰ï¼š");
      if (!input) return;
      const trimmed = input.trim();
      if (!trimmed) return;

      const data = loadToday();
      const emojis = data.emojis || [];
      emojis.push(trimmed);
      saveToday({ emojis });

      registerFirstEmojiIfNeeded();
    }

    function markMainQuest() {
      const data = loadToday();
      if (data.mainCleared) {
        alert("ä»Šå¤©å·²ç»æ ‡è®°ä¸»çº¿é€šå…³å•¦ï¼Œå¯ä»¥å¤šåŠ  emoji å¤¸è‡ªå·±ã€‚");
        return;
      }
      const meta = loadMeta();
      meta.xp = (meta.xp || 0) + 10;
      meta.lastWinDate = todayKey;
      saveMeta(meta);

      const emojis = data.emojis || [];
      emojis.unshift("ğŸ”¥");
      saveToday({ mainCleared: true, emojis });

      alert("ä¸»çº¿é€šå…³ âœ… å·²è·å¾— 10 XPï¼Œå¹¶è‡ªåŠ¨åŠ ä¸Š ğŸ”¥ emojiï¼");
      updateMetaUI();
    }

    function updateWeeklyView() {
      const all = loadAll();
      const days = [];
      const todayDate = new Date(todayKey);

      for (let i = 6; i >= 0; i--) {
        const d = new Date(todayDate);
        d.setDate(d.getDate() - i);
        const key = d.toISOString().slice(0, 10);
        const w = d.getDay();
        const weekChar = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"][w];
        const dayData = all[key] || {};
        const emojis = dayData.emojis || [];
        days.push({
          key,
          weekChar,
          emojis,
        });
      }

      weeklyGrid.innerHTML = "";
      let nonEmpty = 0;
      days.forEach((day) => {
        if (day.emojis.length > 0) nonEmpty++;
        const div = document.createElement("div");
        div.className = "day-cell";

        const box = document.createElement("div");
        box.className = "day-box";
        if (day.emojis.length > 0) {
          box.classList.add("win");
        }

        const topTwo = day.emojis.slice(0, 2);
        if (topTwo.length === 0) {
          const line = document.createElement("div");
          line.className = "day-emoji-line";
          line.textContent = "Â·";
          box.appendChild(line);
        } else {
          topTwo.forEach((e) => {
            const line = document.createElement("div");
            line.className = "day-emoji-line";
            line.textContent = e;
            box.appendChild(line);
          });
        }

        div.appendChild(box);
        const label = document.createElement("div");
        label.textContent = "å‘¨" + day.weekChar;
        div.appendChild(label);

        weeklyGrid.appendChild(div);
      });
      weekSummaryText.textContent = `æœ€è¿‘ 7 å¤©ä¸­ï¼Œæœ‰ emoji çš„å¤©æ•°ï¼š${nonEmpty}/7`;
    }

    function initPrizePoolUI() {
      const meta = loadMeta();
      const lines = (meta.prizePool || []).join("\n");
      prizePoolInput.value = lines;

      prizePoolInput.addEventListener("input", () => {
        const text = prizePoolInput.value || "";
        const arr = text
          .split("\n")
          .map((s) => s.trim())
          .filter((s) => s.length > 0);
        const m = loadMeta();
        m.prizePool = arr;
        saveMeta(m);
        updateLotteryUI();
      });

      if (meta.lastPrizeResult) {
        lotteryResult.textContent = "ä¸Šæ¬¡å¤§å¥–ï¼š";
        lotteryPrize.textContent = meta.lastPrizeResult;
      }
    }

    function updateLotteryUI() {
      const meta = ensureDefaultPrizePool(loadMeta());
      saveMeta(meta);
      const streak = meta.streak || 0;
      const pool = meta.prizePool || [];
      const totalDraws = meta.totalDraws || 0;
      const eligibleDraws = Math.floor(streak / 7);
      const remainingDraws = Math.max(0, eligibleDraws - totalDraws);

      const treasureChest = document.getElementById("treasureChest");
      const lockedChest = document.getElementById("lockedChest");

      if (!pool.length) {
        lotteryStatus.textContent = "å¥–æ± ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ å¥–åŠ±ã€‚";
        treasureChest.style.display = "none";
        lockedChest.style.display = "block";
        return;
      }

      if (remainingDraws > 0) {
        lotteryStatus.textContent = `ğŸ‰ streak ${streak} å¤©ï¼å¯æŠ½ ${remainingDraws} æ¬¡ï¼Œç‚¹å‡»å®ç®±ï¼`;
        treasureChest.style.display = "inline-block";
        lockedChest.style.display = "none";
      } else {
        if (streak < 7) {
          const need = 7 - streak;
          lotteryStatus.textContent = `streak ${streak} å¤©ï¼Œå†åšæŒ ${need} å¤©è§£é”å®ç®±`;
        } else {
          lotteryStatus.textContent = `streak ${streak} å¤©ï¼Œæœ¬è½®å·²æŠ½å®Œï¼Œç»§ç»­æ”’ï¼`;
        }
        treasureChest.style.display = "none";
        lockedChest.style.display = "block";
      }
    }

    function createConfetti() {
      const emojis = ['ğŸ‰', 'âœ¨', 'ğŸŒŸ', 'ğŸ’«', 'ğŸŠ', 'â­', 'ğŸ’–', 'ğŸŒˆ'];
      for (let i = 0; i < 25; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.textContent = emojis[Math.floor(Math.random() * emojis.length)];
          confetti.style.left = Math.random() * 100 + 'vw';
          confetti.style.top = '-30px';
          document.body.appendChild(confetti);
          setTimeout(() => confetti.remove(), 3000);
        }, i * 80);
      }
    }

    function runLottery() {
      let meta = ensureDefaultPrizePool(loadMeta());
      const streak = meta.streak || 0;
      const pool = meta.prizePool || [];
      if (!pool.length) {
        alert("å¥–æ± ä¸ºç©ºï¼Œå…ˆåœ¨ä¸‹æ–¹æ·»åŠ å‡ æ¡å¥–åŠ±å§ã€‚");
        return;
      }
      const totalDraws = meta.totalDraws || 0;
      const eligibleDraws = Math.floor(streak / 7);
      const remainingDraws = Math.max(0, eligibleDraws - totalDraws);
      if (remainingDraws <= 0) {
        alert("æœ¬è½®å¯æŠ½å¥–æ¬¡æ•°å·²ç”¨å®Œï¼Œç»§ç»­æ”’ streak å§ã€‚");
        return;
      }

      const chest = document.getElementById("treasureChest");
      chest.classList.add("shaking");
      lotteryResult.textContent = "âœ¨ å®ç®±æ­£åœ¨æ‘‡æ™ƒ...";
      lotteryPrize.textContent = "";

      // Shake for 1.5 seconds, then open
      setTimeout(() => {
        chest.classList.remove("shaking");
        chest.classList.add("opening");
        chest.textContent = "ğŸŠ";

        // Show prize after opening animation
        setTimeout(() => {
          const finalPrize = pool[Math.floor(Math.random() * pool.length)];
          lotteryResult.textContent = "ğŸ æ­å–œè·å¾—ï¼š";
          lotteryPrize.textContent = finalPrize;
          lotteryPrize.classList.add("prize-reveal");

          createConfetti();

          meta = loadMeta();
          meta.lastPrizeResult = finalPrize;
          meta.totalDraws = (meta.totalDraws || 0) + 1;
          saveMeta(meta);

          // Reset chest after animation
          setTimeout(() => {
            chest.classList.remove("opening");
            chest.textContent = "ğŸ";
            lotteryPrize.classList.remove("prize-reveal");
            updateLotteryUI();
          }, 2000);
        }, 500);
      }, 1500);
    }

    resetBtn.addEventListener("click", () => {
      if (!confirm("ç¡®å®šè¦é‡ç½®ä»Šå¤©æ‰€æœ‰å‹¾é€‰ã€æ–‡å­—å’Œ emoji å—ï¼Ÿ")) return;
      const all = loadAll();
      all[todayKey] = {};
      saveAll(all);
      init();
    });

    addEmojiBtn.addEventListener("click", addEmoji);
    mainQuestBtn.addEventListener("click", markMainQuest);

    copyBtn.addEventListener("click", async () => {
      const data = loadToday();
      const meta = loadMeta();
      const emojis = data.emojis || [];
      const lines = [];
      lines.push(`ã€ä¸‰çº¿æˆ˜æ–—æˆ˜æŠ¥ï½œ${todayKey}ã€‘`);
      lines.push("");
      lines.push(`è¿èƒœï¼š${meta.streak || 0} å¤©ï½œæ€» XPï¼š${meta.xp || 0}`);
      lines.push(`ä»Šæ—¥ emojiï¼š${emojis.length ? emojis.join(" ") : "ï¼ˆæ— ï¼‰"}`);
      lines.push("");
      lines.push("ä¸€ã€ç§‘ç ”");
      lines.push(`- ä»Šæ—¥è®¡åˆ’ï¼š${data.research_plan || "ï¼ˆæœªå¡«å†™ï¼‰"}`);
      lines.push(
        `- æ·±åº¦å·¥ä½œï¼šå—1 ${data.research_block1 ? "âœ…" : "âŒ"}ï½œå—2 ${
          data.research_block2 ? "âœ…" : "âŒ"
        }ï½œæ€»ç»“ï¼š${data.research_summary ? "å·²å†™" : "æœªå†™"}`
      );
      lines.push("");
      lines.push("äºŒã€é‡åŒ–");
      lines.push(
        `- é—®é¢˜æ•´ç†ï¼š${data.quant_prepare ? "âœ…" : "âŒ"}ï½œå¸‚åœºè§‚å¯Ÿï¼š${
          data.quant_note ? "âœ…" : "âŒ"
        }`
      );
      lines.push(`- è®°å½•ï¼š${data.quant_plan || "ï¼ˆæœªå¡«å†™ï¼‰"}`);
      lines.push("");
      lines.push("ä¸‰ã€è‡ªåª’ä½“ / è¾“å‡º");
      lines.push(
        `- é€‰é¢˜è„‘æš´ï¼š${data.media_brainstorm ? "âœ…" : "âŒ"}ï½œåˆ›ä½œåŠ¨ä½œï¼š${
          data.media_create ? "âœ…" : "âŒ"
        }`
      );
      lines.push(`- é€‰é¢˜ / è®°å½•ï¼š${data.media_ideas || "ï¼ˆæœªå¡«å†™ï¼‰"}`);
      lines.push("");
      lines.push("å››ã€æ™šé—´ 3 é—®è®°å½•");
      lines.push(data.review_notes || "ï¼ˆæœªå¡«å†™ï¼‰");

      const text = lines.join("\n");

      try {
        await navigator.clipboard.writeText(text);
        alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¯ä»¥è´´åˆ°æ—¥è®° / Notion é‡Œã€‚");
      } catch (e) {
        alert("å¤åˆ¶å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨å…¨é€‰å¤åˆ¶ã€‚");
      }
    });

    init();
  </script>
</body>
</html>
